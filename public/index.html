<script>
    const baseUrl = "https://demo25-main.onrender.com/api";
    let gameId = null;
    let board = ['-', '-', '-', '-', '-', '-', '-', '-', '-'];
    let currentPlayer = 'X';
    let gameStatus = 'ongoing';

    // Start New Game
    async function startNewGame() {
        const response = await fetch(`${baseUrl}/games`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                player_x: "Alice",
                player_o: "Bob",
                board: board.join(''),
                status: gameStatus,
            })
        });

        const data = await response.json();
        gameId = data.id;
        console.log("Game started with ID:", gameId);
    }

    // Update Game after a Move
    async function updateGame() {
        if (!gameId) return;

        await fetch(`${baseUrl}/games/${gameId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                board: board.join(''),
                status: gameStatus,
            })
        });
    }

    // Load Game State on Page Load
    async function loadGame() {
        const savedGameId = localStorage.getItem("gameId");
        if (!savedGameId) return;

        const response = await fetch(`${baseUrl}/games/${savedGameId}`);
        if (!response.ok) return;

        const data = await response.json();
        board = data.board.split('');
        gameId = data.id;
        gameStatus = data.status;
        renderBoard();
    }

    // Handle Board Rendering
    function renderBoard() {
        board.forEach((cell, index) => {
            const cellElement = document.getElementById(`cell-${index}`);
            cellElement.innerText = cell === '-' ? '' : cell;
        });
    }

    // Handle Cell Clicks
    function handleCellClick(index) {
        if (board[index] === '-' && gameStatus === 'ongoing') {
            board[index] = currentPlayer;
            currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
            renderBoard();
            updateGame(); // Save move to the backend
        }
    }

    // Register Event Listeners
    document.getElementById('start-game').addEventListener('click', () => {
        startNewGame();
        localStorage.setItem("gameId", gameId);
    });

    document.querySelectorAll('.cell').forEach((cell, index) => {
        cell.addEventListener('click', () => handleCellClick(index));
    });

    // Load saved game on page load
    window.onload = () => {
        loadGame();
    };
</script>
